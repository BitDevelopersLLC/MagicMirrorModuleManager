<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MMMM</title>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="./mdl/material.css">
  <script src="./mdl/material.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

  <style>
  .demo-card-wide.mdl-card {
    width: 384px;
  }
  .demo-card-wide > .mdl-card__title {
    color: #fff;
    height: 65px;
    background-color: #485cb0;
  }
  .demo-card-wide > .mdl-card__menu {
    color: #fff;
  }

  .demo-list-control {
    width: 300px;
  }
  .demo-list-radio {
    display: inline;
  }

  #sortable1, #sortable2, #sortable3 {
    border: 1px solid #eee;
    width: 200px;
    min-height: 20px;
    list-style-type: none;
    margin: 0;
    padding: 5px 0 0 0;
    float: left;
    margin-right: 10px;
  }
  #sortable1 li, #sortable2 li, #sortable3 li {
    margin: 0 5px 5px 5px;
    padding: 5px;
    font-size: 1.2em;
    width: 120px;
  }


  </style>
  <script src="http://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script>
  $( function() {
    $( "#sortable1, #sortable2, #sortable3" ).sortable({
      connectWith: ".connectedSortable"
    }).disableSelection();
  } );
  </script>
</head>

<body>

<!-- Start Main Grid -->
  <main class="mdl-layout__content mdl-color--grey-100">
    <div class="mdl-grid demo-content">

      <!-- Start Module List Card -->
      <ul id="sortable1" class="demo-card-wide mdl-shadow--2dp">
        <h3 align="center">Modules</h3>
      </ul>

      <!-- Start Config Card -->
      <div id="configCard" class="demo-card-wide mdl-card mdl-shadow--2dp">

        <div class="mdl-card__title">
          <h2 class="mdl-card__title-text">Config</h2>
        </div>

        <ul id="configList" class="demo-list-control mdl-list">
          <li class="mdl-list__item" id="superman">
            <span class="mdl-list__item-primary-content">
              <i class="material-icons  mdl-list__item-icon">chrome_reader_mode</i>
              Enabled
            </span>
            <span class="mdl-list__item-secondary-action">
              <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="enableButton">
                <input type="checkbox" id="enableButton" class="mdl-switch__input" checked />
              </label>
            </span>
          </li>
        </ul>

        <div class="mdl-card__actions mdl-card--border">
        </div>

        <button id="updateButton" align="center" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" onclick="updateConfig()">
          Update
        </button>

          <!-- Position Button - Top Right -->
          <div class="mdl-card__menu">
            <button id="positionButton"
                    class="mdl-button mdl-js-button mdl-button--icon">
              <i class="material-icons">my_location</i>
            </button>
          </div>
          <ul id="positionList" class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect"
            for="positionButton">
          </ul>
          <!-- End Position Button -->
    </div>

    <div id="demo-toast-example" class="mdl-js-snackbar mdl-snackbar">
      <div class="mdl-snackbar__text"></div>
      <button class="mdl-snackbar__action" type="button"></button>
    </div>
  </main>


<script src="config.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
  var socket = io('http://localhost:8125', {secure: true});

  function sendOutData(data) {
      //console.log(data);
      socket.emit('configUpdate', data);
  }
</script>

<script>
  var rawModules = config.modules;
  var arrayModules = [];
  var mapModulePositions = {};
  var updatedPosition = null;
  var currentPosition = null;
  var updateStatic = false;
  var currentModule = null;

  var dynamicConfig = {};

function triggerHandicap(parts) {
  var updateButton = document.getElementById("updateButton");
  var configCard = document.getElementById("configCard");
  var partKeys = Object.keys(parts);

  for (part in partKeys) {
    var partElement = document.getElementById(partKeys[part]);

    switch (parts[partKeys[part]]) {
        case "disable":
            partElement.disabled = true;
            break;
        case "enable":
            partElement.disabled = false;
            break;
        case "show":
            partElement.style.display = "initial";
            break;
        case "hide":
            partElement.style.display = "none";
            break;
        default:
            console.error("triggerHandicap() was called but the key's value which was passed didn't satisfy any elements.");
    }
  }
}


function updateConfig() {
  if (Object.keys(dynamicConfig).length > 0) {
    pushConfigChanges();
  } else { console.error("This was caused by updateConfig() func being called with no config changes being made, yet updateButton was enabled.") }

}

function pushConfigChanges() {
  if (dynamicConfig.position != null) {
    
  }
  checkConfigCardInputs();
  setTimeout(function () { sendOutData(dynamicConfig, currentModule); }, 5);

}


function appendModules() {
  var ul = document.getElementById("sortable1");
  // Sortable 1 Variable list
  var buttonWidthSync = "180px";
  var arryNumber = -1;


  for (mod in rawModules) {
    var li = document.createElement("li");
    var btn = document.createElement("button");
    li.appendChild(btn);
    li.className = "mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored";
    li.innerHTML = rawModules[mod].module;
    li.style = "cursor:pointer";
    li.style.fontSize = "15px";
    li.style.width = buttonWidthSync;
    li.style.textAlign = "center";
    arrayModules.push(rawModules[mod].module);
    arryNumber = arryNumber + 1;
    li.id = arryNumber;
    ul.appendChild(li);
  }
  ul.addEventListener('click', function(e) {
      if (e.target.tagName == 'SPAN') {

        for (li in this.childNodes) {
          if (this.childNodes[li].tagName == 'LI') {
            //console.log(this.childNodes[li]);
            this.childNodes[li].style.color = "#FFFFFF";
          }
        }
        e.target.parentNode.style.color = "#ec4174";
        var targetName = arrayModules[e.target.parentNode.id];
        $("li[id=configItem]").remove();
        setTimeout(function () {populateConfigCard(findModule(targetName)); }, 20);
      }
  });
}



function populateConfigCard(mod) {
  var ul = document.getElementById("configList");
  updateStatic = false;
  var currentModule = mod;

  if (mod.config != null) {
    var configObjectMap = {};
    for (cfg in mod.config) {
      var li = document.createElement("li");
        li.className = "mdl-list__item lit";
        li.id = "configItem";
        var spanPrimary = document.createElement("span");
          spanPrimary.className = "mdl-list__item-primary-content";
          spanPrimary.innerHTML = cfg + ":  ";
          spanPrimary.style.padding = "10px";
          var spanSecondary = document.createElement("span");
          spanSecondary.className = "mdl-list__item-secondary-action";
          spanSecondary.id = cfg;
          if (mod.config[cfg] != "[object Object]") {
            var div = document.createElement("div");
            div.className = "mdl-textfield mdl-js-textfield mdl-textfield--floating-label is-upgraded";
            var input = document.createElement("input");
                input.className = "mdl-textfield__input";
                input.type = "text"
                input.id = cfg;
                li.onkeyup = function() {
                    updateToggle(this);
                }
              var label = document.createElement("label");
                label.className = "mdl-textfield__label";
                label.htmlFor = cfg
                label.textContent = mod.config[cfg];
                div.appendChild(input);
                div.appendChild(label);
                spanSecondary.appendChild(div);
          }
          else {
            configObjectMap[cfg] = mod.config[cfg][0];
            var button = document.createElement("button");
              button.id = "dropdown" + cfg;
              button.className = "mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon";
              var i = document.createElement("i");
                i.className = "material-icons";
                i.innerHTML = "arrow_drop_down";
              button.appendChild(i);
              spanSecondary.appendChild(button);
              button.onclick = function() {
                    extendConfigItem(this.parentNode.parentNode, configObjectMap[this.parentNode.id]);
                  }
            }

            triggerHandicap({enableButton: "enable", updateButton: "disable", positionButton: "enable"});
            setTimeout(function () { componentHandler.upgradeDom('MaterialTextfield', 'mdl-textfield'); }, 10);
            li.appendChild(spanPrimary);
            li.appendChild(spanSecondary);
            ul.appendChild(li);
      }
    } else {
      if (mod.position == null) {
          if (mod.config == null) {
            triggerHandicap({updateButton: "disable", positionButton: "disable"});
            snackBar(mod.module + ", module isn't configurable.");
          }
        }
      else if (mod.position != null) {
        if (mod.config == null) {
            triggerHandicap({updateButton: "disable", positionButton: "enable", enableButton: "enable"});
            snackBar(mod.module + ", does not have a config, but position is avaiable.")
        }
      }
    }
}

function updateToggle(element) {
  var updateButton = document.getElementById("updateButton");

  checkConfigCardInputs()

  setTimeout(function () {
    if (Object.keys(dynamicConfig).length > 0) {
      updateButton.disabled = false;
    } else {
      updateButton.disabled = true;
    }
   }, 5);
}

function checkConfigCardInputs() {
  var configCard = document.getElementById("configList");
  var newModuleConfig = {};

    if (configCard.childNodes.length > 1) {
      for (li in configCard.childNodes) {
          if (configCard.childNodes[li].id == "configItem") {
            var input = configCard.childNodes[li].childNodes[1].childNodes[0].childNodes[0].value;
            if (input != "") {
              newModuleConfig[configCard.childNodes[li].childNodes[1].id] = input;
            } else {
              delete newModuleConfig[configCard.childNodes[li].childNodes[1].id];
            }
          }
      }
    }
  dynamicConfig = newModuleConfig;
}


function extendConfigItem(configItem, items) {
  var ul = document.createElement("ul");
  ul.className = "demo-list-control mdl-list";
  for (cfg in items) {
      var li = document.createElement("li");
      li.className = "mdl-list__item";
      li.id = cfg;
      li.style.padding = "0px 0px 0px 20px";
      var spanPrimary = document.createElement("span");
        spanPrimary.className = "mdl-list__item-primary-content";
        spanPrimary.innerHTML = cfg + ":  ";
        spanPrimary.style.padding = "10px";
        var spanSecondary = document.createElement("span");
        spanSecondary.className = "mdl-list__item-secondary-action";
        spanSecondary.id = cfg;
        if (items[cfg] != "[object Object]") {
          var div = document.createElement("div");
          div.className = "mdl-textfield mdl-js-textfield mdl-textfield--floating-label is-upgraded";
          var input = document.createElement("input");
              input.className = "mdl-textfield__input";
              input.type = "text";
              input.id = cfg;
              li.onkeyup = function() {
                updateToggle(this);
              }
            var label = document.createElement("label");
              label.className = "mdl-textfield__label";
              label.htmlFor = cfg;
              label.textContent = items[cfg];
              div.appendChild(input);
              div.appendChild(label);
              spanSecondary.appendChild(div);
        }
        else {
          configObjectMap[cfg] = items[cfg][0];
          var button = document.createElement("button");
            button.id = "dropdown" + cfg;
            button.className = "mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon";
            var i = document.createElement("i");
              i.className = "material-icons";
              i.innerHTML = "arrow_drop_down";
            button.appendChild(i);
            spanSecondary.appendChild(button);
            button.onclick = function() {
                  extendConfigItem(this.parentNode.parentNode, configObjectMap[this.parentNode.id]);
                }
          }

          setTimeout(function () { componentHandler.upgradeDom('MaterialTextfield', 'mdl-textfield'); }, 10);
          li.appendChild(spanPrimary);
          li.appendChild(spanSecondary);
          ul.appendChild(li);
    }
    console.info(configItem);
    configItem.appendChild(ul);
}

function populatePositionDropdown() {
  var ul = document.getElementById("positionList");
  var validPositions = positionsNotTaken();

  for (pos in validPositions) {
      var li = document.createElement("li");
      li.className = "mdl-menu__item";
      li.innerHTML = validPositions[pos];
      li.id = validPositions[pos];
      ul.appendChild(li);
  }

  ul.addEventListener('click', function(e) {
      if (e.target.tagName == 'LI'){
        var icon = document.getElementById("positionButton");
        icon.style.color = "#ec4174";
        var updateButton = document.getElementById("updateButton");

        for (li in e.target.parentNode.childNodes) {
          if (e.target.parentNode.childNodes[li].tagName == 'LI') {
            e.target.parentNode.childNodes[li].style.backgroundColor = "#FFFFFF"
          }
        }
        if (e.target.id == updatedPosition) {
          delete dynamicConfig.position;
          if (Object.keys(dynamicConfig).length == 0) {
            updateButton.disabled = true;
          }
          updatedPosition = null;
          e.target.style.backgroundColor = "#FFFFFF";
          icon.style.color = "#FFFFFF";
        } else {
          updateButton.disabled = false;
          updatedPosition = e.target.id;
          e.target.style.backgroundColor = "#ec4174";
          dynamicConfig.position = e.target.id;
        }
      }
  });
  console.log(dynamicConfig);
}

  function findModule(name) {
    for (mod in rawModules) {
      if (rawModules[mod].module == name) {
          //console.info(rawModules[mod]);
          return rawModules[mod];
        }
      }
    }

  function parseModules() {
    for (mod in rawModules) {
      if (rawModules[mod].position != null) {
        mapModulePositions[rawModules[mod].module] = rawModules[mod].position;
      }
    }
  }

  function positionsNotTaken() {
    var allPositions = ["top_bar", "bottom_bar", "top_left", "bottom_left", "top_right", "bottom_right", "top_center", "bottom_center", "upper_third", "middle_center", "lower_center"];
    var notTaken = [];
    for (pos in mapModulePositions) {
      for (var i=allPositions.length-1; i>=0; i--) {
        if (allPositions[i] === mapModulePositions[pos]) {
            allPositions.splice(i, 1);
          }
        }
      }
      return allPositions;
  }

  function sortClick() {
      var sortableItems = $('#sortable1').find('li');
		    var order = ['Calendar', 'Clock', 'Alarm Clock', 'Weather'];
        var orderedItems = $.map(order, function(value) {
          return sortableItems.get(value);
        });

        $('#sortable1').empty().html(order);
      }

    function snackBar(msg) {
        var snackbarContainer = document.querySelector('#demo-toast-example');
        var data = {message: msg};
        snackbarContainer.MaterialSnackbar.showSnackbar(data);
    }

appendModules();
parseModules();
populatePositionDropdown();
triggerHandicap({updateButton: "disable", positionButton: "disable"});
</script>

<script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
<script>window.mdc.autoInit();</script>

 <!--
<form action="/github_upload.php">
	<br></br><br></br>
	<h3> Add New Module: </h3>
	<input type="text" placeholder="Module's GitHub URL"></input>
	<input type="submit" value="Submit">
</form>
 -->


</body>
</html>
